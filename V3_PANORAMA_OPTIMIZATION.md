# V3.0 全景拼接优化说明

## 问题背景

用户场景：**双鱼眼全景相机**，需要将两个鱼眼图像拼接成360°全景。

### 旧版本 (V2.2) 的问题

```python
# V2.2 代码
compensated_bayer[hard_mask == 0] = 0.0  # ❌ 直接清零圆外区域
```

**问题**：
1. 圆外区域被强制清零 → 拼接算法失去边缘过渡区数据
2. 硬边界（0/非0突变） → 拼接接缝明显
3. 丢失原始信息 → 无法进行图像融合

### 拼接场景示意图

```
鱼眼相机1 输出              鱼眼相机2 输出
┌─────────────┐            ┌─────────────┐
│   ███████   │            │   ███████   │
│  █████████  │            │  █████████  │
│ ███████████ │            │ ███████████ │
│ ███████████ │            │ ███████████ │
│  █████████  │            │  █████████  │
│   ███████   │            │   ███████   │
└─────────────┘            └─────────────┘
      ↓                          ↓
   LSC 校正                  LSC 校正
      ↓                          ↓
需要保留边缘 ←─────拼接───────→ 需要保留边缘
```

## V3.0 解决方案

### 核心思想

**"增益=1.0" 而不是 "清零"**

```python
# 圆内有效区
gain = 2.0 ~ 7.0  → 暗角被拉亮 ✅

# 圆边缘过渡区
gain = 1.5 → 1.2 → 1.0  → 平滑过渡 ✅

# 圆外无效区
gain = 1.0  → 保持原始暗值（不放大噪声，不删除数据）✅
```

### 技术实现

#### 1. 增益表层面（calibration.py）

```python
def dampen_gains_by_geometry(..., damping_ratio=1.0, damping_width=60):
    """
    从圆边缘开始，将增益平滑衰减到1.0

    参数调整：
    - damping_ratio: 1.05 → 1.0  (从边缘开始，不留圆外缓冲)
    - damping_width: 50 → 60     (更宽的过渡区)
    """
    start_damp_r = radius * 1.0       # 从圆边缘开始
    end_damp_r = start_damp_r + 60    # 60像素过渡区

    # 圆内：保持LSC增益
    # 过渡区：LSC增益 → 1.0 (线性混合)
    # 圆外：完全是1.0
```

#### 2. Bayer应用层面（bayer_utils.py）

```python
def apply_gains_to_bayer(...):
    """
    V2.2: compensated_bayer[mask==0] = 0.0  ❌ 清零
    V3.0: 不做任何特殊处理                  ✅ 保留

    原因：增益表已经是1.0，所以：
    result = 原始暗值 × 1.0 = 原始暗值（保持不变）
    """
    compensated_bayer = bayer * gain_map  # gain_map圆外=1.0
    # 不再清零！
```

### 效果对比

| 版本 | 圆外处理 | 拼接适用性 | 边缘质量 |
|------|---------|-----------|---------|
| V2.2 | 清零 (×0) | ❌ 不适合 | 硬边界 |
| V3.0 | 保留 (×1.0) | ✅ 完美 | 平滑过渡 |

## 配置参数说明

### config.py 关键参数

```python
# 从哪个半径开始衰减增益
FISHEYE_GAIN_RADIUS_RATIO = 1.0
# 1.0 = 从圆边缘开始（全景拼接推荐）
# 1.05 = 从圆外5%处开始（单相机应用可选）

# 衰减过渡区宽度（像素）
FISHEYE_DAMPING_WIDTH_PIXEL = 60
# 建议范围：30-100
# 太小 → 增益突变环
# 太大 → 侵入有效区
```

## 使用建议

### 全景拼接场景（推荐）

```python
FISHEYE_GAIN_RADIUS_RATIO = 1.0   # 从边缘开始
FISHEYE_DAMPING_WIDTH_PIXEL = 60  # 60像素过渡区
```

### 单相机应用（可选）

如果你不需要拼接，只是想要更激进的边缘校正：

```python
FISHEYE_GAIN_RADIUS_RATIO = 1.05  # 延伸到圆外
FISHEYE_DAMPING_WIDTH_PIXEL = 50  # 稍窄的过渡
```

## 拼接算法建议

使用LSC校正后的图像进行拼接时，建议：

1. **使用加权融合**：
   ```python
   # 根据到圆心距离计算融合权重
   weight1 = soft_mask(distance1, radius1)
   weight2 = soft_mask(distance2, radius2)

   panorama = image1 * weight1 + image2 * weight2
   ```

2. **特征点匹配区域**：
   - 在鱼眼有效区（r < 0.85 * radius）提取特征点
   - 避免使用极边缘区域（可能畸变严重）

3. **曝光补偿**：
   - LSC已校正光照不均，但不同相机间可能仍有曝光差异
   - 在重叠区计算曝光比例并补偿

## 验证方法

### 检查增益表

```python
# 读取输出的增益表
gain_table = np.loadtxt('output/gain_tables/xxx_R_gain_table.txt')

# 检查边缘区域
edge_gains = gain_table[0, :]  # 第一行（图像顶部）
print(edge_gains)  # 应该接近 1.0

center_gains = gain_table[6, 8]  # 中心点
print(center_gains)  # 应该较大（2.0~7.0）
```

### 可视化检查

查看输出的热力图（heatmaps/），应该看到：
- 中心区域：红色（高增益）
- 边缘过渡：黄→绿→蓝（渐变）
- 圆外区域：深蓝色（增益≈1.0）

## 技术细节

### 为什么增益1.0而不是0？

```
场景：圆外暗区，原始像素值=10（很暗）

V2.2 方案：
  gain = 任意值（会被清零逻辑覆盖）
  result = 0  ❌ 数据丢失

V3.0 方案：
  gain = 1.0
  result = 10 × 1.0 = 10  ✅ 保持原样

优势：
1. 不放大噪声（增益不>1.0）
2. 不删除数据（供拼接使用）
3. 保持数值连续性（利于融合）
```

### 与 Demosaic 的兼容性

```python
# Demosaic 算法需要连续的像素值
# V2.2 清零会造成：
Bayer: [10, 12, 0, 0, 0, ...]  ❌ 硬跳变 → Demosaic 伪影

# V3.0 保持暗值：
Bayer: [10, 12, 11, 9, 8, ...]  ✅ 平滑 → Demosaic 正常
```

## 迁移指南

如果你已经使用 V2.2，升级到 V3.0 需要：

1. ✅ 更新代码（已自动完成）
2. ✅ 重新运行校准（使用新的配置参数）
3. ✅ 检查拼接效果（应该有明显改善）

无需改动：
- RAW 文件读取
- 黑电平校正
- 增益计算核心算法（径向拟合）
- 输出格式（高通 13uQ10）

## 总结

V3.0 的核心改进：**"不删除数据，只调整增益"**

- 圆内：LSC 正常校正光照不均 ✅
- 圆外：增益=1.0，保持原始暗值 ✅
- 拼接：平滑过渡，数据完整 ✅

这是针对双鱼眼全景相机的最佳实践！
