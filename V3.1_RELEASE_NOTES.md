# V3.1 版本更新说明

## 重大更新：基于Mask的圆外增益判断

### 问题背景

用户反馈：之前的V3.0版本虽然将圆外区域"增益设为1.0"，但实际查看生成的增益表发现四个角（圆外区域）的增益仍然是1.23左右，并非1.0。

### 根本原因

V3.0使用**径向距离衰减**策略，但存在问题：
```python
# V3.0 旧方法（不准确）
距离 = sqrt((顶点x - 圆心x)² + (顶点y - 圆心y)²)
if 距离 > 半径 * damping_ratio:
    增益 → 1.0
```

问题：
- 使用固定的`damping_ratio`和`damping_width`参数
- 无法精确匹配用户手动圈选的鱼眼mask
- 四个角即使远离圆心，也可能因参数设置不当而没有被正确衰减

### V3.1 解决方案

**核心改进：基于手动圈选mask的精确判断**

```python
# V3.1 新方法（精确）
def dampen_gains_by_mask(gain_matrix, grid_rows, grid_cols, hard_mask, threshold=0.05):
    """
    对于每个增益表顶点：
    1. 检查该顶点周围区域的mask覆盖率
    2. 如果有效像素比例 < threshold（默认5%）→ 增益强制为1.0
    3. 否则保持LSC计算的增益值
    """
    for each vertex in gain_table:
        # 采样该顶点周围半个单元格范围
        sample_region = hard_mask[周围区域]

        valid_ratio = sum(sample_region) / total_pixels

        if valid_ratio < 0.05:  # 几乎无有效像素
            gain[vertex] = 1.0  # 强制为1.0（圆外）
        else:
            gain[vertex] = LSC计算值  # 保持校正（圆内或边界）
```

### 技术优势

| 对比项 | V3.0 (半径衰减) | V3.1 (Mask判断) |
|--------|----------------|----------------|
| **精度** | 粗略（基于几何距离） | 精确（基于实际mask）|
| **适配性** | 假设完美圆形 | 适配任意手动圈选 |
| **边界处理** | 固定过渡区宽度 | 自适应网格边界 |
| **参数调节** | 需调整ratio+width | 仅需调整threshold |
| **圆外增益** | 可能≠1.0 | 保证=1.0 ✅ |

### 关键代码变更

#### 1. 新增函数 (`lsc/calibration.py`)

```python
def dampen_gains_by_mask(gain_matrix, grid_rows, grid_cols, hard_mask, threshold=0.05):
    """
    [V3.1 全景拼接优化 - 基于Mask判断]
    根据手动圈选的mask判断每个网格单元格是否在有效区内。
    """
    # 遍历每个顶点
    for r in range(rows):
        for c in range(cols):
            # 计算该顶点周围的mask覆盖率
            sample_mask = hard_mask[周围区域]
            valid_ratio = np.sum(sample_mask) / sample_mask.size

            # 如果几乎无有效像素 → 强制增益=1.0
            if valid_ratio < threshold:
                dampened[r, c] = 1.0
```

#### 2. 配置参数更新 (`config.py`)

```python
# V3.0 旧参数（已移除）
# FISHEYE_GAIN_RADIUS_RATIO = 1.0
# FISHEYE_DAMPING_WIDTH_PIXEL = 60

# V3.1 新参数
FISHEYE_MASK_THRESHOLD = 0.05  # 5%阈值：顶点周围<5%有效像素→增益1.0
```

### 验证方法

运行校准后检查增益表：

```python
import numpy as np

# 读取增益表
gain_table = np.loadtxt('output/gain_tables/xxx_R_gain_table.txt', comments='#')
gain_table = gain_table.reshape(13, 17)

# 检查四个角（应该=1.0）
print(f"左上角: {gain_table[0, 0]:.4f}")  # 应该接近1.0000
print(f"右上角: {gain_table[0, -1]:.4f}")  # 应该接近1.0000
print(f"左下角: {gain_table[-1, 0]:.4f}")  # 应该接近1.0000
print(f"右下角: {gain_table[-1, -1]:.4f}")  # 应该接近1.0000

# 检查中心点（应该>1.0）
print(f"中心点: {gain_table[6, 8]:.4f}")  # 应该在1.5-7.99之间
```

### 配置建议

#### 全景拼接场景（推荐）
```python
FISHEYE_MASK_THRESHOLD = 0.05  # 5%阈值，严格判断圆外
```

#### 激进边缘校正（可选）
```python
FISHEYE_MASK_THRESHOLD = 0.01  # 1%阈值，更严格
```

### 效果示意

```
增益表热力图（13×17顶点）：

V3.0 (错误):                    V3.1 (正确):
1.23 1.25 1.30 ... 1.25 1.23   1.00 1.00 1.12 ... 1.00 1.00
1.25 1.30 1.45 ... 1.30 1.25   1.00 1.15 1.45 ... 1.15 1.00
1.30 1.45 2.10 ... 1.45 1.30   1.12 1.45 2.10 ... 1.45 1.12
 ...  ...  ...     ...  ...     ...  ...  ...     ...  ...
1.23 1.25 1.30 ... 1.25 1.23   1.00 1.00 1.12 ... 1.00 1.00

问题：四角≠1.0 ❌              正确：四角=1.0 ✅
```

### 其他改进

#### 1. 优化 `analyze_shading.py`

新增专业功能：
- ITU-R BT.709/BT.601标准亮度计算
- 径向标准差分析
- 定量均匀性指标（CV、最大偏差）
- 专业评级系统（A+/A/B/C/D）
- 9宫格综合分析报告

#### 2. 日志输出改进

```python
# V3.1 新增日志
logging.info("  基于Mask衰减: 网格12×16, 阈值=5.0%")
logging.info("    圆外顶点数: 48/221 (21.7%)")  # 实时反馈
```

### 版本历史

- **V2.2**: 基础鱼眼LSC，使用硬遮罩清零圆外
- **V3.0**: 改为增益=1.0（基于半径衰减）→ 但实际不准确
- **V3.1**: 基于Mask精确判断 → **正确实现增益=1.0** ✅

### 升级指南

如果你正在使用V3.0：
1. 拉取最新代码
2. 重新运行`python main.py`
3. 检查新生成的增益表（四角应该=1.0）
4. 验证拼接效果

### 技术支持

如有问题请查看：
- [README.md](README.md) - 完整文档
- [ALGORITHM.md](ALGORITHM.md) - 算法详解
- [V3_PANORAMA_OPTIMIZATION.md](V3_PANORAMA_OPTIMIZATION.md) - 全景拼接优化说明

---

**版本**: V3.1
**日期**: 2025-01-07
**作者**: LSC Calibration Project
**适用场景**: 双鱼眼全景相机LSC校准
