# V3.2 版本优化说明

## 问题回顾

### V3.0/V3.1 存在的问题

用户反馈：
1. V3.0：四个角增益不是1.0（实际1.58左右）
2. V3.1：基于mask阈值判断导致"边缘一块黑一块亮"（棋盘效应）
3. V3.2初期尝试：从80%半径开始衰减 → 圆内有效区被过度衰减 → 偏暗、偏色

### 根本原因分析

**V3.0失败原因**：
- 配置：`RATIO=1.0`, `WIDTH=60`
- 开始衰减半径：1422像素
- 结束衰减半径：1422+60=1482像素
- 四角距离圆心：≈2023像素
- **问题**：2023 >> 1482，理论上应该完全衰减，但增益表顶点坐标计算使得某些顶点没有被正确覆盖

**V3.1失败原因**：
- 使用5%阈值硬判断：顶点要么gain=1.0，要么gain=LSC值
- 边界网格（横跨圆内外）被硬切换 → **棋盘效应**
- 用户正确反馈："边缘都是一块黑一块亮的"

**V3.2初期失败原因**：
- 配置：`RATIO=0.80`, `WIDTH=497`
- 开始衰减半径：1422×0.80=1138像素（**圆内！**）
- 结束衰减半径：1138+497=1635像素
- **问题**：1138-1422像素区域本应正常LSC校正，但被强制衰减 → 圆内边缘欠校正 → 偏暗、偏色

## V3.2 最终解决方案

### 核心策略

**仅衰减圆外区域，圆内完全保留LSC校正**

```python
FISHEYE_GAIN_RADIUS_RATIO = 1.0    # 从100%半径（圆边缘）开始
FISHEYE_DAMPING_WIDTH_PIXEL = 700  # 700像素过渡区
```

### 工作原理

```
距离圆心的距离 (pixels)     |  衰减权重  |  最终增益
------------------------------|-----------|------------------
0 ~ 1422 (圆内)              |  1.0      | 完全保留LSC增益
1422 ~ 2122 (过渡区)         |  1.0→0.0  | 线性混合：LSC → 1.0
> 2122 (完全圆外)            |  0.0      | 强制为1.0
```

### 数学公式

```python
start_damp_r = radius * 1.0 = 1422像素
end_damp_r = 1422 + 700 = 2122像素

对于每个增益表顶点：
  dist = sqrt((x - cx)² + (y - cy)²)

  if dist < 1422:
      weight = 1.0  # 保留LSC
  elif dist > 2122:
      weight = 0.0  # 强制1.0
  else:
      weight = (2122 - dist) / 700  # 线性过渡

  final_gain = lsc_gain * weight + 1.0 * (1 - weight)
```

### 四角增益预测

四角距离圆心 ≈ 2023像素：

```
weight = (2122 - 2023) / 700 = 99 / 700 ≈ 0.14

如果LSC增益=2.0，最终增益：
  final = 2.0 * 0.14 + 1.0 * 0.86 = 0.28 + 0.86 = 1.14
```

**预期结果**：四角增益约1.1-1.2（接近1.0但不完全，保持平滑过渡）

## 技术优势对比

| 版本 | 衰减策略 | 圆内保留 | 平滑过渡 | 四角增益 | 边缘质量 |
|------|---------|---------|---------|---------|---------|
| V3.0 | 半径1.0+60px | ✅ | ⚠️ 过渡区太窄 | 1.58 ❌ | 硬边界 |
| V3.1 | Mask阈值5% | ✅ | ❌ 硬切换 | 1.0 ✅ | 棋盘效应 |
| V3.2初期 | 半径0.80+497px | ❌ 圆内被衰减 | ✅ | 1.05 ✅ | 偏暗偏色 |
| **V3.2最终** | **半径1.0+700px** | **✅** | **✅** | **1.1-1.2** | **平滑自然** |

## 配置建议

### 全景拼接场景（推荐）

```python
FISHEYE_GAIN_RADIUS_RATIO = 1.0
FISHEYE_DAMPING_WIDTH_PIXEL = 700
```

### 激进圆外校正（可选）

如果希望四角更接近1.0：

```python
FISHEYE_GAIN_RADIUS_RATIO = 0.95  # 从95%半径开始
FISHEYE_DAMPING_WIDTH_PIXEL = 800
```

### 保守圆外校正（可选）

如果希望保留更多边缘细节：

```python
FISHEYE_GAIN_RADIUS_RATIO = 1.05  # 延伸到圆外5%
FISHEYE_DAMPING_WIDTH_PIXEL = 600
```

## 验证方法

### 检查增益表

```python
import numpy as np

gain = np.loadtxt('output/gain_tables/2904x2900_R_gain_table.txt', comments='#')
gain_2d = gain.reshape(13, 17)

print(f"四角: {gain_2d[0,0]:.4f}, {gain_2d[0,16]:.4f}, {gain_2d[12,0]:.4f}, {gain_2d[12,16]:.4f}")
print(f"中心: {gain_2d[6,8]:.4f}")
print(f"边缘(圆内): 上{gain_2d[0,8]:.4f}, 下{gain_2d[12,8]:.4f}, 左{gain_2d[6,0]:.4f}, 右{gain_2d[6,16]:.4f}")
```

**预期输出**：
- 四角：1.1-1.2
- 中心：1.0-1.1（最亮区域）
- 边缘（圆内，上下左右）：较高增益（1.5-3.0，暗角区域）

### 可视化检查

查看 `output/heatmaps/` 目录下的增益热力图：
- 中心区域：低增益（蓝色/绿色）
- 圆内边缘：高增益（黄色/红色）← **暗角校正区**
- 圆边缘→四角：渐变到低增益（绿色→蓝色）← **平滑衰减**
- 四角：接近1.0（深蓝色）

## 关键改进总结

1. **精确定位衰减区**：从圆边缘（100%半径）开始，不侵入圆内有效区
2. **足够宽的过渡区**：700像素确保平滑渐变，避免硬边界和棋盘效应
3. **保留LSC校正能力**：圆内完全保留暗角校正，不会偏暗偏色
4. **适配全景拼接**：四角增益接近1.0（约1.1-1.2），保留足够的原始数据供拼接算法使用

---

**版本**: V3.2 Final
**日期**: 2026-01-08
**适用场景**: 双鱼眼全景相机LSC校准
